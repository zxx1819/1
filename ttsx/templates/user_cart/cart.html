{%extends 'base.html'%}

{%block head%}
<script>
	function total() {
		total_all = 0;
		$('.cart_list_td').each(function () {
			price = parseFloat($(this).children('.col05').text());
			count = parseInt($(this).find('.num_show').val());
            total1 = price * count;
            if ($(this).find(':checked').prop('checked')){
            total_all += total1;
            }
            $(this).children('.col07').text(total1.toFixed(2));
        });
		$('.total_count em').text( $('.cart_list_td').length);
		$('.settlements em').text( total_all.toFixed(2));
		$('.settlements b').text( $(':checked:not(#check_all)').length);
    }
    function del(id) {
	    if(confirm('确定要删除么? 亲！'))
        {
            $.get('/cart/delete/',{'id':id},function (data) {
                if(data.ok)
                {
                    $('#'+id).remove();
                    total();
                }
            });
        }

    }
	$(function () {
          total();
        $('#check_all').click(function () {
            var checked = $(this).prop('checked');
            $(':checkbox:not(#check_all)').prop('checked',checked);
            total();
        });

        $('.cart_list_td').click(function () {
            var checkbox_count = $(':checkbox:not(#check_all)').length;
            var checked_count = $(':checked:not(#check_all)').length;
            if(checked_count == checkbox_count)
            {
                $('#check_all').prop('checked',true);
            }
            else
            {
                $('#check_all').prop('checked',false);
            }
            total();

        });


        $('.num_show').blur(function () {
        var count = parseInt($(this).val());
        var kucun = parseInt($(this).parents('.col06').siblings('.col03').children('em').text());
	        if(isNaN(count)){
			    count=1;
			}else if(count<1){
			    count=1;
			}else if(count>kucun){
			    count=kucun;
			}
			$(this).val(count);
			var id = $(this).parents('ul').prop('id');
			$.get('/cart/edit/',{'id':id,'count':count},function (data) {
                if(data.ok)
                {
                    total();
                }
            });

    })

        $('.add').click(function () {
            var count = $(this).next().val();
            count++;
            $(this).next().val(count).blur();
        });

        $('.minus').click(function () {
            var count = $('.minus').prev().val();
            count--;
            $(this).prev().val(count).blur();

        });

	});


</script>
{%endblock head%}

{%block body%}
	<div class="total_count">全部商品<em>2</em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

    <form method="post" action="/cart/order/">
    {% csrf_token %}
	{%for cart in cart_list%}
		<ul class="cart_list_td clearfix" id="{{ cart.id }}">
			<li class="col01"><input type="checkbox" name="cart_id" value="{{ cart.id }}" checked="checked"></li>
			<li class="col02"><img src="/static/{{cart.goods.gpic}}"></li>
			<li class="col03">{{ cart.goods.gtitle }}<br><em>{{cart.goods.gkucun}}</em></li>
			<li class="col04">{{cart.goods.gunit}}</li>
			<li class="col05">{{cart.goods.gprice}}</li>
			<li class="col06">
				<div class="num_add">
					<a href="javascript:;" class="add fl">+</a>
					<input type="text" class="num_show fl" value="{{cart.count}}">
					<a href="javascript:;" class="minus fl">-</a>
				</div>
			</li>
			<li class="col07"></li>
			<li class="col08"><a href="javascript:del({{ cart.id }});">删除</a></li>
		</ul>
	{%endfor%}


	<ul class="settlements">
		<li class="col01"><input type="checkbox" id="check_all" checked="checked"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em>42.60</em><br>共计<b>2</b>件商品</li>
		<li class="col04"><input type="submit" value="去结算">去结算</li>
	</ul>
</form>
{%endblock body%}

